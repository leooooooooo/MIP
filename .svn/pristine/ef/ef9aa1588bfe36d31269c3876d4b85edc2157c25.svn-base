//
//  UploadRequestDecorator.m
//  Common
//
//  Created by wang hao on 13-9-3.
//  Copyright (c) 2013年 __MyCompanyName__. All rights reserved.
//

#import "UploadRequestDecorator.h"
#import "UIImage+CustomExtensions.h"
#import "UIColor+CustomExtensions.h"

@interface UploadRequestDecorator()

@end

@implementation UploadRequestDecorator

@synthesize delegate;


-(void)setDelegate:(id<ASIHTTPUploadDelegate>)nDelegate{
    
    _originalClass = object_getClass(nDelegate);
    
    _delegate = nDelegate;
}


/*!
 @function	
 @abstract      初始化网络请求，对父类方法进行重写，设置请求代理和上传代理
 
 @param         request                 已经完成初始化的请求
 
 @result      
 */
-(id)initWithASIHTTPRequest:(ASIHTTPRequest *)request{
    
    self = [super initWithASIHTTPRequest:request];
    
    _request.delegate = self;
    _request.uploadProgressDelegate = self;
    _totalSize = [[_request postBody] length];
    
    return self;
}

- (void)dealloc {
    
    self.delegate = nil;
    
    [super dealloc];
}



/*!
 @function	
 @abstract      执行网络请求，对父类方法进行重写，展示上传界面
 
 @param     
 
 @result      
 */
-(NSError *)executeRequest{
    [self creatAlertViewForProgress];
    NSError *error = [super executeRequest];
    return error;
}



/*!
 @function	
 @abstract      ASIHTTPRequestDelegate回调，在接受报文头后的处理，展示进度条，若需要后续处理由代理调用
 
 @param         responseHeaders         返回HTTP头 
 @param         request                 请求   
 
 @result      
 */
-(void)request:(ASIHTTPRequest *)request didReceiveResponseHeaders:(NSDictionary *)responseHeaders {
    
    //将提示信息从请稍等更新为上传中
//#warning 将提示信息从请稍等更新为上传中
//    NSLog(@"%@   %@",request.url,responseHeaders);
//    [self receiveHTTPResponseHeaders:responseHeaders request:request];
}



/*!
 @function	
 @abstract      ASIHTTPRequestDelegate回调，请求完成后处理
 
 @param         request                 请求
 
 @result      
 */
-(void)requestFinished:(ASIHTTPRequest *)request {
    
    //上传完成
    //关闭进图条
    [self hideLoadingProgressView:request success:YES];
    
    //调用代理uploadRequestFinished方法通知
    Class currentClass = object_getClass(_delegate);
    
    if (currentClass == _originalClass) {
        
        if ([_delegate respondsToSelector:@selector(uploadRequestFinished:)]) {
            
            [_delegate uploadRequestFinished:request];
        }
    }
}



/*!
 @function	
 @abstract      ASIHTTPRequestDelegate回调，请求失败后处理
 
 @param         request                 请求   
 
 @result      
 */
-(void)requestFailed:(ASIHTTPRequest *)request {
    
    //上传失败
    //关闭进图条
    [self hideLoadingProgressView:request success:NO];
 
    //调用代理downloadRequestFaild方法通知
    NSLog(@"%@",request.error);
    
    Class currentClass = object_getClass(_delegate);
    
    if (currentClass == _originalClass) {
        
        if ([_delegate respondsToSelector:@selector(uploadRequestFailed:)]) {
            
            [_delegate uploadRequestFailed:request];
        }
    }    
}



/*!
 @function	
 @abstract      ASIProgressDelegate回调，在接受数据后的处理，展示进度条
 
 @param         size                    上传包大小
 @param         responseHeaders         返回HTTP头 
 
 @result      
 */
- (void)request:(ASIHTTPRequest *)request didSendBytes:(long long)bytes {
    //更新上传进度
    //更新进度条信息
    [self showRequest:request bytesInTotal:[request totalBytesSent]];
}



/*!
 @function	
 @abstract      创建AlertView类型进度条，重写父类方法，下载的AlertView类型进度条
 
 @param
 
 @result
 */
-(void)creatAlertViewForProgress {
    
//    if (!self.progressAlertView.isVisible && _request)
    if (!self.progressAlertView && _request){
        
//        UIAlertView *alertView = [[UIAlertView alloc] init];
//        [alertView setMessage:NSLocalizedString(@"请等待",nil)];
//        [alertView setTitle:@"上传中"];
        
        CustomNewAlertView *alertView = [[CustomNewAlertView alloc] initWithTitle:@"上传中" message:@"" delegate:nil cancelButtonTitle:nil otherButtonTitles:nil];
        [alertView setTitleColor:[UIColor whiteColor] font:[UIFont systemFontOfSize:24]];
        UIView *bgView = [[UIView alloc] initWithFrame:CGRectMake(10, 50, 360, 80)];
        [alertView addTheview:bgView];
        [bgView setBackgroundColor:[UIColor whiteColor]];
        [bgView release];
        //创建进度条
        UIProgressView *progView = [[UIProgressView alloc] initWithFrame:CGRectMake(20.0f, 30.0f, 320.0f, 20.0f)];
        [progView setProgressViewStyle:UIProgressViewStyleBar];
        
        UIImage *img = [UIImage imageNamed:@"loading_02.png" imageBundle:@"Sandglass"];
        
        [progView  setProgressImage:img ];
        [progView  setTrackImage:[UIImage imageNamed:@"loading_01.png" imageBundle:@"Sandglass"]];
        
        [bgView addSubview:progView];
        [alertView setAlertHeight:140];
        [alertView setAlertWidth:380];
        [progView release];
        
        //创建进度条信息显示
        UILabel *label = [[UILabel alloc] initWithFrame:CGRectMake(30.0f, 40.0f, 260.0f, 30.0f)];
        label.backgroundColor = [UIColor clearColor];
        label.textAlignment = UITextAlignmentCenter;
        label.textColor = [UIColor colorWithHex:@"5582A1"];
        label.font = [UIFont systemFontOfSize:16.0f];
        label.text = @"";
        [bgView addSubview:label];
        [label release];
        
        //下载取消按钮
        UIButton *btnCancelLoad = [UIButton buttonWithType:UIButtonTypeCustom];
        btnCancelLoad.frame = CGRectMake(335, 0, 35, 35);
        NSBundle *bundle = [NSBundle bundleWithPath:[[NSBundle mainBundle] pathForResource:@"Main" ofType:@"bundle"]];
        NSString *imagePath = [bundle pathForResource:@"button_delete" ofType:@"png"];
        [btnCancelLoad setImage:[UIImage imageWithContentsOfFile:imagePath] forState:UIControlStateNormal];
        [btnCancelLoad addTarget:self action:@selector(cancelCurrentRequest) forControlEvents:UIControlEventTouchUpInside];
        [alertView addTheview:btnCancelLoad];
        
        [alertView show];
        
        self.progressAlertView  = alertView;
        self.progressView       = progView;
        self.progressText       = label;
        
        [alertView release];
    }   
}

@end
