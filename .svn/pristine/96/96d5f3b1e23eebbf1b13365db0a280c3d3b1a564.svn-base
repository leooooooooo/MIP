/* 
 * Copyright (c) 2009 Keith Lazuka
 * License: http://www.opensource.org/licenses/mit-license.html
 */

#import "KalViewController.h"
#import "KalLogic.h"
#import "KalDataSource.h"
#import "KalDate.h"
#import "KalPrivate.h"

#define PROFILER 0
#if PROFILER
#include <mach/mach_time.h>
#include <time.h>
#include <math.h>
void mach_absolute_difference(uint64_t end, uint64_t start, struct timespec *tp)
{
    uint64_t difference = end - start;
    static mach_timebase_info_data_t info = {0,0};

    if (info.denom == 0)
        mach_timebase_info(&info);
    
    uint64_t elapsednano = difference * (info.numer / info.denom);
    tp->tv_sec = elapsednano * 1e-9;
    tp->tv_nsec = elapsednano - (tp->tv_sec * 1e9);
}
#endif

NSString *const KalDataSourceChangedNotification = @"KalDataSourceChangedNotification";

@interface KalViewController ()
@property (nonatomic, retain, readwrite) NSDate *initialDate;
@property (nonatomic, retain, readwrite) NSDate *selectedDate;
- (KalView*)calendarView;
@end

@implementation KalViewController
@synthesize dataSource,selectedDate,viewDelegate;
- (id)initWithSelectedDate:(NSDate *)date
{
  if ((self = [super init])) {
    logic = [[KalLogic alloc] initForDate:date];
    self.initialDate = date;
    self.selectedDate = date;
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(significantTimeChangeOccurred) name:UIApplicationSignificantTimeChangeNotification object:nil];
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(reloadData) name:KalDataSourceChangedNotification object:nil];
  }
    
  return self;
}

- (id)init
{
  return [self initWithSelectedDate:[NSDate date]];
}

//日历视图
- (KalView*)calendarView
{
    return (KalView*)self.view;
}

- (void)setDataSource:(id<KalDataSource>)aDataSource
{
  if (dataSource != aDataSource)
  {
    dataSource = aDataSource;
  }
}



- (void)clearTable
{
  [dataSource removeAllItems];

}

- (void)reloadData
{
  [dataSource presentingDatesFrom:logic.fromDate to:logic.toDate delegate:self];
}

- (void)significantTimeChangeOccurred
{
  [[self calendarView] jumpToSelectedMonth];
  [self reloadData];
}

// -----------------------------------------
#pragma mark KalViewDelegate protocol

- (void)didSelectDate:(KalDate *)date
{
  self.selectedDate = [date NSDate];
  NSDate *from = [[date NSDate] cc_dateByMovingToBeginningOfDay];
  NSDate *to = [[date NSDate] cc_dateByMovingToEndOfDay];
    
    if(self.viewDelegate && [self.viewDelegate respondsToSelector:@selector(didSelectDate:)])
    {
        [self.viewDelegate didSelectDate:self.selectedDate];
    }
    
    [dataSource loadItemsFromDate:from toDate:to];
    
    [[self calendarView] setDateLabelWithDate:[date NSDate]];
    
    if (viewDelegate)
    {
        [viewDelegate selectDateWith:[date NSDate]];
    }
}

-(void)showPreviousMonthSlideDown
{
 
    [logic retreatToPreviousMonth];
    KalDate *from =  [logic.daysInSelectedMonth objectAtIndex:0];
    KalDate *to =  [logic.daysInSelectedMonth lastObject];
    NSDate *fromDate = [from NSDate];
    NSDate *toDate = [to NSDate];
    [[self calendarView] slideDown];

    //传出月开始日期和结束日期
    if (self.viewDelegate && [self.viewDelegate respondsToSelector:@selector(showPreviousMonthDownFrom:to:)])
    {
        [self.viewDelegate showPreviousMonthDownFrom:fromDate to:toDate];
    }
    

    

}



-(void)showPreviousMonthSlideRight
{

    [logic retreatToPreviousMonth];
    KalDate *from =  [logic.daysInSelectedMonth objectAtIndex:0];
    KalDate *to =  [logic.daysInSelectedMonth lastObject];
    NSDate *fromDate = [from NSDate];
    NSDate *toDate = [to NSDate];
    [[self calendarView] slideRight];

    //传出月开始日期和结束日期
    if (self.viewDelegate && [self.viewDelegate respondsToSelector:@selector(showPreviousMonthRightFrom:to:)])
    {
        [self.viewDelegate showPreviousMonthRightFrom:fromDate to:toDate];
    }
    

}
-(void)showFollowingMonthSlideLeft
{
    [logic advanceToFollowingMonth];
    
    KalDate *from =  [logic.daysInSelectedMonth objectAtIndex:0];
    KalDate *to =  [logic.daysInSelectedMonth lastObject];
    NSDate *fromDate = [from NSDate];
    NSDate *toDate = [to NSDate];
    [[self calendarView] slideLeft];

    //传出月开始日期和结束日期
    if (self.viewDelegate && [self.viewDelegate respondsToSelector:@selector(showFollowingMonthLeftFrom:to:)])
    {
        [self.viewDelegate showFollowingMonthLeftFrom:fromDate to:toDate];
    }
    
}
-(void)showFollowingMonthSlideUp
{
 
  [logic advanceToFollowingMonth];
    
    KalDate *from =  [logic.daysInSelectedMonth objectAtIndex:0];
    KalDate *to =  [logic.daysInSelectedMonth lastObject];
    NSDate *fromDate = [from NSDate];
    NSDate *toDate = [to NSDate];
    [[self calendarView] slideUp];

    //传出月开始日期和结束日期
    if (self.viewDelegate && [self.viewDelegate respondsToSelector:@selector(showFollowingMonthUpFrom:to:: to:)])
    {
        [self.viewDelegate showFollowingMonthUpFrom:fromDate to:toDate];
    }
    
 
    
}

// -----------------------------------------
#pragma mark KalDataSourceCallbacks protocol

- (void)loadedDataSource:(id<KalDataSource>)theDataSource;
{
  NSArray *markedDates = [theDataSource markedDatesFrom:logic.fromDate to:logic.toDate];
  NSMutableArray *dates = [[markedDates mutableCopy] autorelease];
  for (int i=0; i<[dates count]; i++)
    [dates replaceObjectAtIndex:i withObject:[KalDate dateFromNSDate:[dates objectAtIndex:i]]];
  
  [[self calendarView] markTilesForDates:dates];
  [self didSelectDate:self.calendarView.selectedDate];
}

// ---------------------------------------
#pragma mark -

- (void)showAndSelectDate:(NSDate *)date
{
  if ([[self calendarView] isSliding])
    return;
  
  [logic moveToMonthForDate:date];
  
#if PROFILER
  uint64_t start, end;
  struct timespec tp;
  start = mach_absolute_time();
#endif
  
  [[self calendarView] jumpToSelectedMonth];
  
#if PROFILER
  end = mach_absolute_time();
  mach_absolute_difference(end, start, &tp);
  printf("[[self calendarView] jumpToSelectedMonth]: %.1f ms\n", tp.tv_nsec / 1e6);
#endif
  
  [[self calendarView] selectDate:[KalDate dateFromNSDate:date]];
  [self reloadData];
    
    if (viewDelegate)
    {
        [viewDelegate selectDateWith:date];
    }
}

- (NSDate *)selectedDate
{
  return [self.calendarView.selectedDate NSDate];
}


// -----------------------------------------------------------------------------------
#pragma mark UIViewController

- (void)didReceiveMemoryWarning
{
  self.initialDate = self.selectedDate; // must be done before calling super
  [super didReceiveMemoryWarning];
}

- (void)loadView
{
  if (!self.title)
    self.title = @"Calendar";

  kalView = [[[KalView alloc] initWithFrame:CGRectMake(5, 0, 429, 380) delegate:self logic:logic] autorelease];
    kalView.delegate = self;
  kalView.backgroundColor = [UIColor clearColor];
  self.view = kalView;
    
  [kalView selectDate:[KalDate dateFromNSDate:self.initialDate]];
    
  [self reloadData];
    
//    self.view.backgroundColor = [UIColor yellowColor];
}

- (void)jumpToDateWith:(NSDate *)date;
{
    [self showAndSelectDate:date];
    [self showAndSelectDate:date];
}

- (void)viewDidUnload
{
  [super viewDidUnload];

}

- (void)viewWillAppear:(BOOL)animated
{
  [super viewWillAppear:animated];
}

- (void)viewDidAppear:(BOOL)animated
{
  [super viewDidAppear:animated];
}


-(void)setDictionary:(NSDictionary *)dic
{

    kalView.schduleDictionary = dic;
}



#pragma mark -

- (void)dealloc
{
  [[NSNotificationCenter defaultCenter] removeObserver:self name:UIApplicationSignificantTimeChangeNotification object:nil];
  [[NSNotificationCenter defaultCenter] removeObserver:self name:KalDataSourceChangedNotification object:nil];
  [initialDate release];
  [selectedDate release];
  [logic release];
  [super dealloc];
}

@end
